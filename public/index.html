<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindOS - AI Assistant with Memory</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Auth Screen - keeping existing styles */
        .auth-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: white;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .auth-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .auth-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
        }
        
        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
        }
        
        .auth-btn:disabled {
            opacity: 0.6;
            transform: none;
        }
        
        /* Chat Interface */
        .chat-app {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        /* Header with session info */
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
        }
        
        .header-info {
            flex: 1;
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
        }
        
        .memory-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            margin-left: 1rem;
        }
        
        /* Enhanced Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1.5rem;
        }
        
        .sidebar-user {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        
        .sidebar-menu {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        .menu-section {
            margin-bottom: 1rem;
        }
        
        .menu-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
        }
        
        .menu-item:hover {
            background: #f5f5f5;
        }
        
        .menu-item i {
            width: 20px;
            margin-right: 1rem;
            color: #667eea;
        }
        
        /* Enhanced memory item with actions */
        .memory-item {
            padding: 0.75rem 1rem;
            border-left: 3px solid #667eea;
            margin: 0.5rem 1rem;
            background: #f8f9ff;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .memory-item:hover {
            background: #eef2ff;
            transform: translateX(2px);
        }
        
        .memory-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .memory-type {
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            font-size: 0.7rem;
        }
        
        .memory-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .memory-item:hover .memory-actions {
            opacity: 1;
        }
        
        .memory-action-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        
        .memory-action-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .memory-action-btn.delete {
            color: #e74c3c;
        }
        
        .memory-action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .memory-content {
            color: #333;
            line-height: 1.3;
        }
        
        .memory-metadata {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #eee;
        }
        
        /* Chat Messages */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            max-width: 85%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.assistant {
            align-self: flex-start;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #667eea;
            color: white;
        }
        
        .message.assistant .message-avatar {
            background: #764ba2;
            color: white;
        }
        
        .message-content {
            background: white;
            border-radius: 18px;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .message.user .message-content {
            background: #667eea;
            color: white;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 0.25rem;
            text-align: center;
        }
        
        .memory-stored-indicator {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        
        .memory-deleted-indicator {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        /* Input Area */
        .input-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .input-group {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 25px;
            padding: 0.5rem 1rem;
        }
        
        .message-input {
            flex: 1;
            border: none;
            background: none;
            padding: 0.5rem;
            font-size: 1rem;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            transform: none;
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        /* Memory Detail Modal */
        .memory-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }
        
        .memory-modal.show {
            display: flex;
        }
        
        .memory-modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .memory-modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .memory-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .memory-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            color: #666;
        }
        
        .memory-detail-section {
            margin-bottom: 1.5rem;
        }
        
        .memory-detail-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        
        .memory-detail-value {
            background: #f8f9ff;
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 0.5rem;
        }
        
        .memory-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            border-top: 1px solid #eee;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: #5a6fd8;
        }
        
        .modal-btn.danger {
            background: #e74c3c;
            color: white;
        }
        
        .modal-btn.danger:hover {
            background: #c0392b;
        }
        
        .modal-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-btn.secondary:hover {
            background: #e9e9e9;
        }
        
        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2100;
        }
        
        .confirm-dialog.show {
            display: flex;
        }
        
        .confirm-dialog-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .confirm-dialog-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .confirm-dialog-message {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .confirm-dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .loading { opacity: 0.6; }
        
        /* Alert */
        .alert {
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .alert.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        
        .alert.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                left: -280px;
            }
            
            .memory-modal {
                padding: 1rem;
            }
            
            .memory-modal-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <div class="auth-header">
                <h1>MindOS</h1>
                <p>Your Personal AI Assistant with Memory</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showLogin()">Login</div>
                <div class="auth-tab" onclick="showRegister()">Register</div>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Password">
                </div>
                <button class="auth-btn" onclick="login()">Login</button>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="registerUsername" placeholder="Choose username">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Create password">
                </div>
                <button class="auth-btn" onclick="register()">Register</button>
            </div>
        </div>
        
        <div id="authAlert"></div>
    </div>
    
    <!-- Chat App -->
    <div id="chatApp" class="chat-app">
        <!-- Header -->
        <div class="chat-header">
            <button class="hamburger" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="header-info">
                <div class="header-title">MindOS</div>
                <div class="header-subtitle" id="headerStatus">AI Assistant Ready</div>
                <div class="session-info">
                    <span id="sessionMessages">0 messages</span>
                    <span class="memory-count" id="memoryCount">0 memories</span>
                </div>
            </div>
            <div class="online-indicator"></div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div id="sidebarUsername">User</div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Online</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">Quick Actions</div>
                    <button class="menu-item" onclick="quickAction('plan-day')">
                        <i class="fas fa-calendar-day"></i>
                        Plan My Day
                    </button>
                    <button class="menu-item" onclick="quickAction('set-goals')">
                        <i class="fas fa-bullseye"></i>
                        Set Goals
                    </button>
                    <button class="menu-item" onclick="quickAction('create-routine')">
                        <i class="fas fa-repeat"></i>
                        Create Routine
                    </button>
                    <button class="menu-item" onclick="quickAction('daily-review')">
                        <i class="fas fa-chart-line"></i>
                        Daily Review
                    </button>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Memory Management</div>
                    <button class="menu-item" onclick="viewAllMemories()">
                        <i class="fas fa-brain"></i>
                        View All Memories
                    </button>
                    <button class="menu-item" onclick="refreshMemories()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Memories
                    </button>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Recent Memories</div>
                    <div id="recentMemories">
                        <!-- Recent memories will be loaded here -->
                    </div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Session</div>
                    <button class="menu-item" onclick="clearSession()">
                        <i class="fas fa-broom"></i>
                        Clear Session
                    </button>
                    <button class="menu-item" onclick="exportChat()">
                        <i class="fas fa-download"></i>
                        Export Chat
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
        
        <!-- Overlay -->
        <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
        
        <!-- Memory Detail Modal -->
        <div class="memory-modal" id="memoryModal">
            <div class="memory-modal-content">
                <div class="memory-modal-header">
                    <div class="memory-modal-title">Memory Details</div>
                    <button class="memory-modal-close" onclick="closeMemoryModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="memoryModalContent">
                    <!-- Memory details will be loaded here -->
                </div>
                <div class="memory-modal-actions">
                    <button class="modal-btn secondary" onclick="closeMemoryModal()">Close</button>
                    <button class="modal-btn primary" onclick="openMemoryChat()">Discuss with AI</button>
                    <button class="modal-btn danger" onclick="confirmDeleteMemory()">Delete Memory</button>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Dialog -->
        <div class="confirm-dialog" id="confirmDialog">
            <div class="confirm-dialog-content">
                <div class="confirm-dialog-title">Confirm Action</div>
                <div class="confirm-dialog-message" id="confirmMessage">
                    Are you sure you want to proceed?
                </div>
                <div class="confirm-dialog-actions">
                    <button class="modal-btn secondary" onclick="closeConfirmDialog()">Cancel</button>
                    <button class="modal-btn danger" id="confirmActionBtn" onclick="executeConfirmedAction()">Confirm</button>
                </div>
            </div>
        </div>
        
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="messages" id="messages">
                <!-- Welcome message will be added here -->
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="input-group">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Message MindOS..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let token = localStorage.getItem('mindos_token');
        let user = JSON.parse(localStorage.getItem('mindos_user') || '{}');
        let isLoading = false;
        let sessionInfo = {};
        let userMemories = [];
        let selectedMemory = null;
        let pendingAction = null;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (token && token !== 'null' && token !== 'undefined') {
                attemptAutoLogin();
            } else {
                showAuthScreen();
            }
        });
        
        async function attemptAutoLogin() {
            try {
                const response = await fetch('/api/user-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showChatApp();
                } else {
                    clearAuth();
                    showAuthScreen();
                }
            } catch (error) {
                console.log('Auto-login failed:', error);
                clearAuth();
                showAuthScreen();
            }
        }
        
        function clearAuth() {
            localStorage.removeItem('mindos_token');
            localStorage.removeItem('mindos_user');
            token = null;
            user = {};
        }
        
        // Auth functions (keeping existing)
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.querySelectorAll('.auth-tab')[1].classList.remove('active');
        }
        
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.querySelectorAll('.auth-tab')[0].classList.remove('active');
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
        }
        
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    user = data.user;
                    localStorage.setItem('mindos_token', token);
                    localStorage.setItem('mindos_user', JSON.stringify(user));
                    showChatApp();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Login failed: ' + error.message, 'error');
            }
        }
        
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !email || !password) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    user = data.user;
                    localStorage.setItem('mindos_token', token);
                    localStorage.setItem('mindos_user', JSON.stringify(user));
                    showChatApp();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Registration failed: ' + error.message, 'error');
            }
        }
        
        function logout() {
            clearAuth();
            showAuthScreen();
            closeSidebar();
        }
        
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('chatApp').classList.add('hidden');
        }
        
        async function showChatApp() {
            document.getElementById('authScreen').classList.add('hidden');
            const chatApp = document.getElementById('chatApp');
            chatApp.classList.remove('hidden');
            chatApp.style.display = 'flex';
            document.getElementById('sidebarUsername').textContent = user.username || 'User';
            
            // Load session info and memories
            await loadSessionInfo();
            await loadMemories();
            
            addWelcomeMessage();
        }
        
        async function loadSessionInfo() {
            try {
                const response = await fetch('/api/session-info', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    sessionInfo = await response.json();
                    updateSessionDisplay();
                }
            } catch (error) {
                console.log('Failed to load session info:', error);
            }
        }
        
        async function loadMemories() {
            try {
                const response = await fetch('/api/memories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    userMemories = await response.json();
                    updateMemoryDisplay();
                }
            } catch (error) {
                console.log('Failed to load memories:', error);
            }
        }
        
        function updateSessionDisplay() {
            const messagesCount = sessionInfo.messageCount || 0;
            document.getElementById('sessionMessages').textContent = `${messagesCount} messages`;
        }
        
        function updateMemoryDisplay() {
            document.getElementById('memoryCount').textContent = `${userMemories.length} memories`;
            
            // Update recent memories in sidebar with enhanced UI
            const recentMemoriesDiv = document.getElementById('recentMemories');
            recentMemoriesDiv.innerHTML = '';
            
            const recentMemories = userMemories.slice(0, 8);
            recentMemories.forEach(memory => {
                const memoryDiv = document.createElement('div');
                memoryDiv.className = 'memory-item';
                memoryDiv.setAttribute('data-memory-id', memory.id);
                
                // Build metadata string
                let metadata = '';
                if (memory.priority && memory.priority > 3) metadata += 'â­ ';
                if (memory.performance_streak && memory.performance_streak > 0) {
                    metadata += `ðŸ”¥${memory.performance_streak}d `;
                }
                if (memory.stage) metadata += `[${memory.stage}] `;
                
                memoryDiv.innerHTML = `
                    <div class="memory-item-header">
                        <div class="memory-type">${memory.type || 'general'}</div>
                        <div class="memory-actions">
                            <button class="memory-action-btn" onclick="viewMemoryDetails(${memory.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="memory-action-btn delete" onclick="confirmDeleteMemoryDirect(${memory.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="memory-content">${memory.content_short || memory.content?.substring(0, 80) || 'No content'}</div>
                    ${metadata ? `<div class="memory-metadata">${metadata}</div>` : ''}
                `;
                
                // Add click handler for memory details
                memoryDiv.addEventListener('click', (e) => {
                    if (!e.target.closest('.memory-actions')) {
                        viewMemoryDetails(memory.id);
                    }
                });
                
                recentMemoriesDiv.appendChild(memoryDiv);
            });
            
            if (recentMemories.length === 0) {
                recentMemoriesDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: #888; font-size: 0.9rem;">No memories yet</div>';
            }
        }
        
        // NEW: Memory detail viewing functionality
        function viewMemoryDetails(memoryId) {
            const memory = userMemories.find(m => m.id === memoryId);
            if (!memory) return;
            
            selectedMemory = memory;
            
            // Build detailed view
            const modalContent = document.getElementById('memoryModalContent');
            modalContent.innerHTML = '';
            
            // Display all available fields
            const fields = [
                { key: 'type', label: 'Type', value: memory.type },
                { key: 'content', label: 'Full Content', value: memory.content },
                { key: 'content_short', label: 'Summary', value: memory.content_short },
                { key: 'notes', label: 'Notes', value: memory.notes },
                { key: 'priority', label: 'Priority', value: memory.priority ? `${memory.priority}/5` : null },
                { key: 'status', label: 'Status', value: memory.status },
                { key: 'stage', label: 'Stage', value: memory.stage },
                { key: 'performance_streak', label: 'Current Streak', value: memory.performance_streak ? `${memory.performance_streak} days` : null },
                { key: 'performance_rate', label: 'Success Rate', value: memory.performance_rate ? `${Math.round(memory.performance_rate * 100)}%` : null },
                { key: 'due', label: 'Due Date', value: memory.due },
                { key: 'trigger', label: 'Trigger', value: memory.trigger },
                { key: 'energy_requirements', label: 'Energy Level', value: memory.energy_requirements },
                { key: 'required_time', label: 'Time Required', value: memory.required_time },
                { key: 'success_criteria', label: 'Success Criteria', value: memory.success_criteria },
                { key: 'resources', label: 'Resources', value: memory.resources },
                { key: 'location', label: 'Location', value: memory.location },
                { key: 'weather', label: 'Weather Context', value: memory.weather },
                { key: 'mood', label: 'Mood', value: memory.mood },
                { key: 'emotion', label: 'Emotion', value: memory.emotion },
                { key: 'search_query', label: 'Related Searches', value: memory.search_query },
                { key: 'shoppingideas', label: 'Shopping Ideas', value: memory.shoppingideas },
                { key: 'created_at', label: 'Created', value: memory.created_at },
                { key: 'modified', label: 'Last Modified', value: memory.modified }
            ];
            
            fields.forEach(field => {
                if (field.value && field.value !== '' && field.value !== null) {
                    const section = document.createElement('div');
                    section.className = 'memory-detail-section';
                    section.innerHTML = `
                        <div class="memory-detail-label">${field.label}</div>
                        <div class="memory-detail-value">${field.value}</div>
                    `;
                    modalContent.appendChild(section);
                }
            });
            
            // Show modal
            document.getElementById('memoryModal').classList.add('show');
        }
        
        function closeMemoryModal() {
            document.getElementById('memoryModal').classList.remove('show');
            selectedMemory = null;
        }
        
        // NEW: Open chat about specific memory
        function openMemoryChat() {
            if (!selectedMemory) return;
            
            closeMemoryModal();
            closeSidebar();
            
            // Create a detailed prompt about this memory
            const memoryPrompt = `I'd like to discuss this specific memory in detail:

**Type**: ${selectedMemory.type}
**Content**: ${selectedMemory.content}
${selectedMemory.notes ? `**Notes**: ${selectedMemory.notes}` : ''}
${selectedMemory.priority ? `**Priority**: ${selectedMemory.priority}/5` : ''}
${selectedMemory.status ? `**Status**: ${selectedMemory.status}` : ''}
${selectedMemory.stage ? `**Stage**: ${selectedMemory.stage}` : ''}

Please provide full context about this memory and help me with any modifications, additional details, or related planning I might need.`;
            
            document.getElementById('messageInput').value = memoryPrompt;
            sendMessage();
        }
        
        // NEW: Memory deletion functionality
        function confirmDeleteMemoryDirect(memoryId) {
            const memory = userMemories.find(m => m.id === memoryId);
            if (!memory) return;
            
            showConfirmDialog(
                'Delete Memory',
                `Are you sure you want to delete this memory?\n\n"${memory.content_short || memory.content?.substring(0, 100) || 'Memory'}"`,
                () => deleteMemory(memoryId)
            );
        }
        
        function confirmDeleteMemory() {
            if (!selectedMemory) return;
            
            showConfirmDialog(
                'Delete Memory',
                `Are you sure you want to delete this memory?\n\n"${selectedMemory.content_short || selectedMemory.content?.substring(0, 100) || 'Memory'}"`,
                () => {
                    deleteMemory(selectedMemory.id);
                    closeMemoryModal();
                }
            );
        }
        
        async function deleteMemory(memoryId) {
            try {
                const response = await fetch(`/api/memories/${memoryId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    // Remove from local array
                    userMemories = userMemories.filter(m => m.id !== memoryId);
                    updateMemoryDisplay();
                    
                    // Add success message to chat
                    addMessage('assistant', 'Memory deleted successfully. The information has been removed from my knowledge base.');
                    
                    // Add visual indicator
                    const lastMessage = document.querySelector('.message.assistant:last-child .message-content');
                    const indicator = document.createElement('div');
                    indicator.className = 'memory-deleted-indicator';
                    indicator.innerHTML = '<i class="fas fa-trash"></i> Memory deleted';
                    lastMessage.appendChild(indicator);
                    
                    showAlert('Memory deleted successfully', 'success');
                } else {
                    const error = await response.json();
                    showAlert('Failed to delete memory: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Delete memory error:', error);
                showAlert('Error deleting memory: ' + error.message, 'error');
            }
        }
        
        // Confirmation dialog functions
        function showConfirmDialog(title, message, onConfirm) {
            document.querySelector('.confirm-dialog-title').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            pendingAction = onConfirm;
            document.getElementById('confirmDialog').classList.add('show');
        }
        
        function closeConfirmDialog() {
            document.getElementById('confirmDialog').classList.remove('show');
            pendingAction = null;
        }
        
        function executeConfirmedAction() {
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
            closeConfirmDialog();
        }
        
        function addWelcomeMessage() {
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer.children.length === 0) {
                addMessage('assistant', `Hello! I'm MindOS, your personal AI assistant with memory capabilities. I can remember our conversations, your goals, routines, and preferences to provide personalized assistance.\n\nI currently have ${userMemories.length} stored memories about you. You can view, discuss, or delete any memory by clicking on them in the sidebar.\n\nWhat would you like to work on today?`);
            }
        }
        
        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
            }
        }
        
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
        }
        
        // Quick actions
        function quickAction(action) {
            const actions = {
                'plan-day': 'Help me plan my day based on my goals, routines, and priorities. Consider my stored memories and preferences.',
                'set-goals': 'I want to set some new goals. Help me define them clearly and create a plan to achieve them.',
                'create-routine': 'Help me create a new daily or weekly routine that aligns with my goals and lifestyle.',
                'daily-review': 'Let\'s do a daily review. How did I do today with my goals and routines? What can I improve?'
            };
            
            const message = actions[action];
            if (message) {
                document.getElementById('messageInput').value = message;
                sendMessage();
            }
            closeSidebar();
        }
        
        async function viewAllMemories() {
            if (userMemories.length === 0) {
                addMessage('assistant', 'You don\'t have any stored memories yet. As we chat and you share important information about your goals, routines, and preferences, I\'ll automatically store relevant details for future reference.');
            } else {
                const memoryText = userMemories.map(m => 
                    `**${m.type?.toUpperCase() || 'GENERAL'}**: ${m.content_short || m.content?.substring(0, 100) || 'No content'}${m.notes ? `\n   _${m.notes}_` : ''}`
                ).join('\n\n');
                
                addMessage('assistant', `Here are all your stored memories:\n\n${memoryText}\n\nI use these memories to provide personalized assistance and remember important details about your goals and preferences. You can click on any memory in the sidebar to view full details, discuss it with me, or delete it if needed.`);
            }
            closeSidebar();
        }
        
        async function refreshMemories() {
            await loadMemories();
            await loadSessionInfo();
            showAlert('Memories refreshed successfully', 'success');
            closeSidebar();
        }
        
        async function clearSession() {
            try {
                const response = await fetch('/api/clear-session', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    document.getElementById('messages').innerHTML = '';
                    sessionInfo = { messageCount: 0 };
                    updateSessionDisplay();
                    addWelcomeMessage();
                    showAlert('Session cleared successfully', 'success');
                } else {
                    showAlert('Failed to clear session', 'error');
                }
            } catch (error) {
                showAlert('Error clearing session: ' + error.message, 'error');
            }
            closeSidebar();
        }
        
        function exportChat() {
            const messages = Array.from(document.querySelectorAll('.message')).map(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.querySelector('.message-content').textContent;
                return `${isUser ? 'You' : 'MindOS'}: ${content}`;
            }).join('\n\n');
            
            const blob = new Blob([messages], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mindos-chat-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            closeSidebar();
        }
        
        // Enhanced chat functions
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || isLoading) return;
            
            addMessage('user', message);
            input.value = '';
            autoResize(input);
            
            setLoading(true);
            
            try {
                const response = await fetch('/api/claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: message
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const assistantMessage = data.content[0].text;
                    addMessage('assistant', assistantMessage);
                    
                    // Check if memory was stored (tool use indicates this)
                    const hasToolUse = data.content.some(content => content.type === 'tool_use');
                    if (hasToolUse) {
                        // Refresh memories and session info
                        await loadMemories();
                        await loadSessionInfo();
                        
                        // Add indicator that memory was stored
                        const lastMessage = document.querySelector('.message.assistant:last-child .message-content');
                        const indicator = document.createElement('div');
                        indicator.className = 'memory-stored-indicator';
                        indicator.innerHTML = '<i class="fas fa-brain"></i> Memory stored';
                        lastMessage.appendChild(indicator);
                    }
                    
                    // Update session info
                    sessionInfo.messageCount = (sessionInfo.messageCount || 0) + 2; // user + assistant
                    updateSessionDisplay();
                    
                } else {
                    const errorData = await response.json();
                    showAlert('Failed to send message: ' + (errorData.error || response.statusText), 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
            
            setLoading(false);
        }
        
        function addMessage(type, content) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'}
                </div>
                <div>
                    <div class="message-content">${content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/_(.*?)_/g, '<em>$1</em>')}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function setLoading(loading) {
            isLoading = loading;
            const typingIndicator = document.getElementById('typingIndicator');
            const sendBtn = document.getElementById('sendBtn');
            
            if (loading) {
                typingIndicator.style.display = 'flex';
                sendBtn.disabled = true;
                document.getElementById('headerStatus').textContent = 'MindOS is thinking...';
            } else {
                typingIndicator.style.display = 'none';
                sendBtn.disabled = false;
                document.getElementById('headerStatus').textContent = 'AI Assistant Ready';
            }
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            const authAlert = document.getElementById('authAlert');
            authAlert.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('memory-modal')) {
                closeMemoryModal();
            }
            if (event.target.classList.contains('confirm-dialog')) {
                closeConfirmDialog();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeMemoryModal();
                closeConfirmDialog();
                closeSidebar();
            }
        });
    </script>
</body>
</html>
